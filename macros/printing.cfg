[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|default(110)|int %}
  {% set target_extruder = params.EXTRUDER|default(150)|int %}
  {% set target_chamber = params.CHAMBER|default(0)|int %}
  {% set filament_type = params.FILAMENT|default("ABS")|upper %}
  {% set preheat_filament_types = printer['gcode_macro _USER_VARIABLE'].preheat_filament_types %}
  {% set ena_auto_z_offset = printer['gcode_macro _USER_VARIABLE'].auto_z_offset|lower %}
  {% set ena_quad_gantry_level = printer['gcode_macro _USER_VARIABLE'].quad_gantry_level|lower %}
  {% set ena_bed_mesh = printer['gcode_macro _USER_VARIABLE'].bed_mesh|lower %}
  {% set plate_offset_z = printer.save_variables.variables.plate_array[printer.save_variables.variables.plate_index|int][1] %}
  {% set plate_name = printer.save_variables.variables.plate_array[printer.save_variables.variables.plate_index|int][0] %}
  {% set default_display_lights_color = printer['gcode_macro _USER_VARIABLE'].default_display_lights_color|lower %}
  {% set default_case_lights_color = printer['gcode_macro _USER_VARIABLE'].default_case_lights_color|lower %}
  
  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {action_respond_info('==== PRINT_START ====')}
    {action_respond_info("targets [bed: %s, extruder: %s, chamber: %s]" % (target_bed,target_extruder,target_chamber))}
    {action_respond_info("filament_type: %s" % (filament_type))}
    {action_respond_info("preheat_filament_types: %s" % (preheat_filament_types|join(',')))}
    {action_respond_info("ena_auto_z_offset: %s" % (ena_auto_z_offset))}
    {action_respond_info("ena_quad_gantry_level: %s" % (ena_quad_gantry_level))}
    {action_respond_info("ena_bed_mesh: %s" % (ena_bed_mesh))}
    {action_respond_info("plate_name: %s" % (plate_name))}
    {action_respond_info("plate_offset_z: %s" % (plate_offset_z))}
    {% if printer.bed_mesh %}
      {action_respond_info("bed_mesh_profile_name: %s" % (printer.bed_mesh.profile_name))}
    {% endif %}
    {action_respond_info("default_display_lights_color: %s" % (default_display_lights_color))}
    {action_respond_info("default_case_lights_color: %s" % (default_case_lights_color))}
    {action_respond_info('===============')}
  {% endif %}

  {default_display_lights_color} CASE=0
  {default_case_lights_color} DISPLAY=0

  M117 Homing
  G28

    {% if ena_bed_mesh == "true" %}
        {% if printer.bed_mesh.profile_name %}
        M119 Loading Mesh {printer.bed_mesh.profile_name}
        BED_MESH_PROFILE LOAD={printer.bed_mesh.profile_name}
        {% else %}
        M117 Calibrating Mesh
        BED_MESH_CALIBRATE
        BED_MESH_PROFILE LOAD=default
        {% endif %}
    {% endif %}

  M117 Heating ~extruder~: {target_extruder}~degrees~
  M109 S{target_extruder} # Wait for extruder final temp

  G1 Z5 F5000 # Move head 5mm from bed surface
  G90 # Absolute Positioning
  M83 # Make the E relative independant of other axis
  G1 E9 F1500 # Unretract filament
  RESET_EXTRUDER

  M117 Printing

[gcode_macro PRINT_END]
gcode:
  {% set retract_end = printer['gcode_macro _USER_VARIABLE'].retract_end %}
  {% set can_extrude = printer.extruder.can_extrude|lower %}
  {% set min_x = printer.toolhead.axis_minimum.x|float %}
  {% set max_y = printer.toolhead.axis_maximum.y|float %}
  {% set boarder_delta = printer['gcode_macro _USER_VARIABLE'].boarder_delta|float %}
  {% set park_x = min_x + boarder_delta %}
  {% set park_y = max_y - boarder_delta %}
  {% set default_display_lights_color = printer['gcode_macro _USER_VARIABLE'].default_display_lights_color|lower %}
  {% set default_case_lights_color = printer['gcode_macro _USER_VARIABLE'].default_case_lights_color|lower %}

  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {action_respond_info('==== PRINT_END ====')}
    {action_respond_info("retract_end: %s" % (retract_end))}
    {action_respond_info("can_extrude: %s" % (can_extrude))}
    {action_respond_info("min_x: %s" % (min_x))}
    {action_respond_info("max_y: %s" % (max_y))}
    {action_respond_info("boarder_delta: %s" % (boarder_delta))}
    {action_respond_info("park_x: %s" % (park_x))}
    {action_respond_info("park_y: %s" % (park_y))}
    {action_respond_info("default_display_lights_color: %s" % (default_display_lights_color))}
    {action_respond_info("default_case_lights_color: %s" % (default_case_lights_color))}
    {action_respond_info('===============')}
  {% endif %}

  M400  # wait for buffer to clear
  {% if can_extrude == 'true' %}
    G92 E0  # zero the extruder
    G1 E-{retract_end} F3600  # retract filament
  {% endif %}
  G91 # relative positioning
  G0 Z1.00 X20.0 Y20.0 F20000 # move nozzle to remove stringing
  TURN_OFF_HEATERS
  M107  # turn off fan
  G1 Z2 F3000 # move nozzle up 2mm
  G90 # absolute positioning
  G0 X{park_x} Y{park_y} F18000 # park nozzle at rear 
  BED_MESH_CLEAR
  M84
  
  M117 Clean Nozzle!
  PUSHOVER_PRINT_COMPLETE

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  {% if printer['gcode_macro _USER_VARIABLE'].debug == 1 %}
    {action_respond_info('==== CANCEL_PRINT ====')}
    {action_respond_info('======================')}
  {% endif %}

  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  PRINT_END
  BASE_CANCEL_PRINT